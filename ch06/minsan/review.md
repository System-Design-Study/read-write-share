이번 장에서는 키-값 분산 저장소를 설계하는 과정을 살펴보았다.

앞의 5장에서 살펴본 안정 해시의 내용이 많이 포함되어 있어서, 관련 내용을 다루는 곳에서는 읽는 데 큰 어려움은 없었지만 생소한 부분들이 많아서 조금 어렵게 느껴지기도 했다.

이번 장은 `일관성`과 `가용성` 사이에서 **어떤 기준으로 트레이드오프**를 해야하며, **`일관성 수준`은 어떻게 조절할 수 있는지**를 중심으로 이해하면 좋을 것 같다.

# CAP 정리 - 분산 시스템 설계

분산 시스템을 설계할 경우, CAP 정리에 대해서 이해하고 이를 기반으로 요구사항에 적합한 시스템을 선택해야 한다.

특히 네트워크 장애는 현실에서 피할 수 없는 문제이기 때문에, **파티션 감내**를 고려한 상태에서 `가용성`과 `일관성`의 트레이드오프가 필요하다. _(CP vs AP)_

- 가령 은행 시스템처럼 일관성이 중요한 서비스에서는 가용성을 일부 포기하는 **CP 시스템**을 설계하는 것이 적합하다. _(일부 노드에 문제가 발생하면 시스템 중단)_

# 정족수 합의 프로토콜 - 데이터 일관성 조절

읽기 / 쓰기에 대해서 정족수 합의 수를 조절함으로써 데이터의 일관성 수준을 조절할 수 있다.

- 정족수가 많아질수록 일관성은 높아지지만, 그만큼 가용성은 낮아진다.

예를들어 빠른 읽기를 제공하되 쓰기 연산에서는 높은 일관성을 보장하고자 하는 경우에는 `R` 값은 1로, `W` 값은 서버 노드의 수로 설정할 수 있다.

# 결과적 일관성의 이해

결과적 일관성은 쓰기 작업이 일부 노드에서만 성공하더라도, 즉각적으로 모든 노드에 반영되지 않아도 된다. 즉, 즉각적인 동기화가 필요하지 않다.

일정 시간이 지나면(= 서버 내부적으로 동기화 처리가 끝나면), 결국에는 모든 노드가 동일한 데이터를 가지게 된다.

- 이해하기 쉬운 예시로는 `SNS 피드`가 있다.
  1. 사용자가 트윗을 업로드하면, 즉시 모든 팔로워들에게 노출되지 않을 수 있다. _(일부 노드에는 쓰기 작업이 완료되었지만, 모든 노드에는 아직 반영되지 않음)_
  2. 일부의 서버(노드)에만 저장된 후, 점차 다른 서버로 전파됨
  3. 몇 초 후에는 모든 사용자에게 동일한 타임라인이 보장된다.

### 토스 ?

스터디 과정에서 `토스 어플리케이션` 동작 방식에 관해서도 이야기가 나왔는데, 이 내용도 기록해두면 좋을 것 같다.

```
1. 토스 어플리케이션을 실행하면, 계좌 정보가 뜨고 해당 계좌의 잔액을 보여준다.
2. 이때 '계좌의 잔액이 실시간 잔액과 일치하지 않는 경우'가 존재한다.
3. 클라이언트가 계좌 거래 내역 페이지로 진입하면 실시간 정보로 업데이트 된다.
```

스터디 이후에 이 경우가 결과적 일관성의 적용 예시에 해당하는지에 대해서 다시 한번 생각해볼 수 있었다.

먼저, 해당 기능이 결과적 일관성의 적용 예시가 맞는지 의구심이 들었던 이유는 **클라이언트의 직접적인 행동에 의해** 데이터가 동기화 된다는 점이었다.

- 그에 반해 `결과적 일관성`은 서버 내부에서 자체적으로 동기화를 진행한다.
  - 네트워크 통신 지연처럼, 서버 내부적인 요인으로 인해 일정 시간이 지난 후에야 모든 서버가 동기화 된다.

토스 어플 사용경험을 떠올려보면, 새로 추가된 거래 내역을 불러올 때 **은행 API**를 사용하는 듯 보인다. _(추측 ..)_

- 만약 그렇다면 이 기능에는 결과적 일관성보다는 **캐싱**이 적용됐다고 보는 것이 적합할 것 같다.
  1. 메인 화면에 접근할 때는 빠른 화면 로딩을 위해 가장 최근에 조회되었던 잔액을 띄워줌
  2. 상세 정보로 접근할 때는 API를 호출하여 실시간 정보로 업데이트

> 실제 토스 어플이 어떻게 구현되어 있는지 모르기 때문에 이 부분에 대한 해답은 얻을 수 없었지만, 서버 내부 구현 방식에 따라서 적용되는 동기화 기술을 고민해볼 수 있었다.

# 결과적 일관성 vs 정족수 프로토콜

결과적 일관성에 대해 학습하다보니 정족수 프로토콜과의 관계성(?)이 헷갈리기 시작했다.

- 그렇다면, 정족수 프로토콜은 결과적 일관성을 구현하기 위해 사용하는 기술인건가?

정족수 프로토콜과 결과적 일관성은 서로 목적이 조금 다르다.

- 정족수 프로토콜은 일관성과 가용성 사이의 밸런스를 원하는 수준으로 맞추기 위해 사용하는 것이다.
- 결과적 일관성은 일시적으로 최소한의 일관성을 보장하면서 가용성을 높이는 것이다. _(일부 서버에 저장된 이후에는 서버 뒷단에서 이를 전파시킴)_

정리하자면, 정족수 프로토콜로 결과적 일관성 모델을 구축할 수 있다.  
하지만 정족수 프로토콜이 결과적 일관성 모델을 항상 구축하는 것은 아니다.

> 👉🏻 상황에 맞게 정족수 프로토콜을 적용함으로써 다양한 모델을 구축할 수 있다.
