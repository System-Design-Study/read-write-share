# ch05 안정 해시 설계

## 안정 해시(Consistent Hashing)란?

안정 해시는 시스템의 노드(예: 캐시 서버, 데이터 파티션 등)가 추가되거나 제거될 때 전체 키(key)의 재분배를 최소화하는 해싱 기법입니다. 
전통적인 해시 기법은

```
serverIndex = hash(key) % N
```

와 같이 단순히 서버의 총 개수 N으로 나눈 나머지를 사용하지만, 이 경우 서버의 증감에 따라 대부분의 키가 새롭게 재배치되어 캐시 미스(cache miss)나 데이터 재분배로 인한 성능 저하가 발생할 수 있습니다.

반면, 안정 해시는 해시 테이블 크기가 조정될 때 평균적으로 오직 k/n 개의 키만 이동하게 하여(여기서 k는 전체 키의 수, n은 슬롯(또는 서버)의 수) 재분배 비용을 크게 낮춥니다.

---

## 해시 공간과 해시 링

### 해시 공간

안정 해시는 먼저 해시 함수(예: SHA-1)를 통해 정의되는 해시 공간을 사용합니다. 예를 들어 SHA-1의 경우 해시 출력 범위는 0부터 2^160 - 1까지입니다. 이 거대한 숫자 범위 내에서 키와 서버의 위치를 결정할 수 있습니다.

### 해시 링(Hash Ring)

해시 공간의 양 끝(0과 2^160 - 1)을 이어 붙이면 마치 원형 구조(링)를 만들 수 있습니다.

•	서버 배치: 각 서버는 고유한 식별자(IP나 이름 등)를 해시 함수에 넣어 링 상의 특정 위치에 배치됩니다.

•	키 배치: 각 데이터 키 또한 해시 함수를 통해 링 상의 어느 지점에 매핑됩니다.

•	저장 위치 결정: 특정 키를 저장할 서버는, 그 키의 위치부터 시계 방향(원형으로 이어진 다음)에 처음으로 만나는 서버가 담당하게 됩니다.

이런 구조 덕분에 서버의 추가 또는 제거 시 전체 해시 공간 중 일부에 해당하는 키만 재배치되며, 나머지 키는 영향을 받지 않습니다.

___

## 서버 추가 및 제거 시의 안정성

### 서버 추가

새로운 서버를 추가하면, 기존의 해시 링 상에 위치하던 서버들 사이의 특정 구간(파티션)에 분포하던 키들 중 일부만 새 서버로 이동하게 됩니다. 예를 들어, 서버 s0와 s3 사이에 s4가 추가되면 s0와 s4 사이에 존재하는 키만 s4로 재배치됩니다.

### 서버 제거

서버 제거 역시 마찬가지입니다. 제거된 서버가 담당하던 키들은 제거된 서버 바로 다음에 위치한 서버로 재분배되므로, 전체 키의 일부만 이동하게 됩니다.

이러한 특성 덕분에 서버의 변화에 따른 데이터 재분배 비용과 캐시 미스 위험을 현저히 줄일 수 있습니다.

---
## 기본 구현 시 발생하는 문제점

안정 해시의 기본 아이디어는 매우 강력하지만, 몇 가지 문제점도 존재합니다.

### 1.	불균등한 파티션 크기:

초기에는 서버들이 균등하게 해시 링 상에 분포한다고 하더라도, 중간에 서버를 추가하거나 제거하면 일부 서버는 다른 서버보다 훨씬 넓은 해시 공간(파티션)을 담당하게 될 수 있습니다. 이로 인해 데이터가 한쪽으로 치우치는 불균형 문제가 발생할 수 있습니다.

### 2.	균등 분포 달성의 어려움:
해시 함수의 특성 상, 서버와 키가 완벽하게 균등하게 분포되지 않을 수 있습니다. 예를 들어, 어떤 서버는 거의 키를 받지 못하고, 다른 서버는 다량의 키를 담당하는 상황이 발생할 수 있습니다.

---

## 가상 노드(Virtual Node)로 해결하기

이러한 불균형 문제를 해소하기 위해 도입된 것이 가상 노드(Virtual Node, VNode) 개념입니다.

### •	개념:

하나의 실제 서버가 해시 링 상에 여러 개의 가상 노드로 나타납니다. 각 가상 노드는 실제 서버를 참조하며, 여러 개의 가상 노드를 통해 전체 해시 공간을 보다 세밀하게 분할할 수 있습니다.

### •	효과:

가상 노드의 개수를 늘리면 각 서버가 담당하는 키의 분포가 더욱 균등해집니다. 통계적으로 표준 편차가 작아져, 특정 서버에 키가 몰리는 현상을 완화할 수 있습니다.
다만, 가상 노드의 수를 늘리면 추가적인 메타 데이터 저장 공간이 필요하므로, 시스템의 요구사항에 따라 적절한 개수를 결정해야 합니다.

---

## 안정 해시의 장점 및 실제 적용 사례

### 장점
•	최소한의 키 재배치:
서버 추가/제거 시 전체 키의 일부만 이동하므로, 데이터 재분배 비용이 낮고 캐시 미스 문제를 줄일 수 있습니다.
•	수평적 확장성:
데이터가 균등하게 분포되기 때문에, 시스템 확장 시 특정 서버에 과부하가 걸리는 것을 방지하고, 안정적인 성능을 유지할 수 있습니다.
•	핫스팟(Hotspot)키 문제 완화:
특정 샤드에 데이터가 몰리는 현상을 줄여서, 서버 간의 부하를 고르게 분산시킵니다.

### 실제 적용 사례

안정 해시는 여러 대규모 시스템에서 활용되고 있습니다. 대표적인 사례는 다음과 같습니다.
•	Amazon DynamoDB:
데이터 파티셔닝 컴포넌트에 안정 해시 기법을 사용하여 확장성과 장애 내성을 확보합니다.
•	Apache Cassandra:
클러스터 내 데이터 분산을 위해 안정 해시를 활용합니다.
•	Discord:
채팅 애플리케이션에서 메시지 및 데이터 분산에 안정 해시를 적용합니다.
•	Akamai CDN 및 Meglev:
네트워크 부하 분산 및 콘텐츠 전송에 있어 안정 해시를 이용하여 효율적인 트래픽 분산을 구현합니다.